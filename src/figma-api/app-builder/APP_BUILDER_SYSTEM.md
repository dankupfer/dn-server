# App Builder System

## Overview

The App Builder is a server-side service that transforms Figma designs into fully functional React Native applications. It takes a `fullAppConfig.json` file (generated by the Figma plugin) and automatically:

1. Parses component configurations
2. Generates module files (Journey and ScreenBuilder components)
3. Creates routing files for navigation
4. Configures the app with proper theming and API settings
5. Packages everything into a ready-to-run application

## Architecture Philosophy

### Design-to-Code Pipeline
- **Figma → JSON**: Designer creates app structure in Figma
- **JSON → Code**: Server generates React Native modules and routing
- **Zero Manual Coding**: Fully automated app generation
- **Template-Based**: Uses pre-configured app templates (App.assist.tsx)

### Three-Tier Routing System

The app builder creates three distinct routing layers based on `fullAppConfig.json`:

#### 1. **Carousel Routes** (`carouselRoutes.tsx`)
Horizontal carousel sections - the main content areas

**When to use**: `section_type: "main-carousel"` AND `sectionHome: true`

**Available sections**:
- `summary` - Account overview and balance
- `everyday` - Daily banking operations
- `invest` - Investment and savings
- `borrow` - Loans and credit
- `homes` - Home and property services
- `insurance` - Insurance products

#### 2. **Bottom Nav Routes** (`bottomNavRoutes.tsx`)
Bottom navigation tabs and modal overlays

**When to use**: 
- `section_type: "slide-panel"` AND `sectionHome: true` → Tab
- `section_type: "modal"` AND `sectionHome: true` → Modal overlay

**Tab sections**:
- `home` - Main home screen
- `apply` - Application flows
- `cards` - Card management

**Modal sections**:
- `payments` - Payment processing
- `search` - Search functionality

#### 3. **Child Routes** (`childRoutes.tsx`)
Standalone screens accessible from any section

**When to use**: `sectionHome: false`

**Presentation types**:
- `slide` - Slides in from right (default navigation)
- `modal` - Presents as overlay
- `full` - Full-screen takeover

## Router File Structures

### carouselRoutes.tsx

```typescript
// Generated by App Builder
import React from 'react';
import GeneratedSummary from '../../feature/generated-myapp3/summary-screen';
import GeneratedEveryday from '../../feature/generated-myapp3/everyday-screen';
import GeneratedInvest from '../../feature/generated-myapp3/invest-screen';

export interface CarouselRoute {
  id: string;
  name: string;
  component: React.ComponentType<{ screenWidth: number }>;
}

export const carouselRoutes: CarouselRoute[] = [
  { id: 'summary', name: 'Summary', component: GeneratedSummary },
  { id: 'everyday', name: 'Everyday', component: GeneratedEveryday },
  { id: 'invest', name: 'Invest', component: GeneratedInvest },
  // Builder adds routes here based on main-carousel components
];
```

### bottomNavRoutes.tsx

```typescript
// Generated by App Builder
import React from 'react';
import HomeScreen from '../../feature/generated-myapp3/home-screen';
import ApplyScreen from '../../feature/generated-myapp3/apply-screen';
import CardsScreen from '../../feature/generated-myapp3/cards-screen';
import PaymentsModal from '../../feature/generated-myapp3/payments-modal';
import SearchModal from '../../feature/generated-myapp3/search-modal';

export interface BottomNavRoute {
  id: string;
  name: string;
  type: 'tab' | 'modal';
  component: React.ComponentType<{ screenWidth: number }>;
}

export const bottomNavRoutes: BottomNavRoute[] = [
  // Tabs - render as bottom nav sections
  { id: 'home', name: 'Home', type: 'tab', component: HomeScreen },
  { id: 'apply', name: 'Apply', type: 'tab', component: ApplyScreen },
  { id: 'cards', name: 'Cards', type: 'tab', component: CardsScreen },
  
  // Modals - render as overlays
  { id: 'payments', name: 'Payments', type: 'modal', component: PaymentsModal },
  { id: 'search', name: 'Search', type: 'modal', component: SearchModal },
];
```

### childRoutes.tsx

```typescript
// Generated by App Builder
import React from 'react';
import AccountDetailScreen from '../../feature/generated-myapp3/account-detail';
import TransactionScreen from '../../feature/generated-myapp3/transaction-detail';
import SettingsScreen from '../../feature/generated-myapp3/settings';

export interface ChildRoute {
  id: string;
  name: string;
  type: 'slide' | 'modal' | 'full';
  component: React.ComponentType<{ screenWidth: number }>;
}

export const childRoutes: ChildRoute[] = [
  { id: 'account-detail', name: 'Account Detail', type: 'slide', component: AccountDetailScreen },
  { id: 'transaction', name: 'Transaction', type: 'modal', component: TransactionScreen },
  { id: 'settings', name: 'Settings', type: 'full', component: SettingsScreen },
  // Builder adds child screens here
];
```

## fullAppConfig.json Mapping

### Input Structure

```json
{
  "appName": "myApp3",
  "appFrame": {
    "appName": "myApp3",
    "brand": "BrandA",
    "mode": "light",
    "apiBase": "http://localhost:3001"
  },
  "components": [
    {
      "componentName": "ScreenBuilder_frame",
      "nodeId": "289:19",
      "properties": {
        "id": "screen-1",
        "section_type": "main-carousel",
        "sectionHome": true,
        "sectionHomeOption": "Summary"
      }
    },
    {
      "componentName": "Journey",
      "nodeId": "287:675",
      "properties": {
        "journeyOption": "AssistJourney",
        "prop0": "assist-journey-1",
        "prop1": "main-carousel",
        "prop2": true,
        "prop3": "customer-1",
        "sectionHomeOption": "everyday"
      }
    },
    {
      "componentName": "ScreenBuilder_frame",
      "nodeId": "289:23",
      "properties": {
        "id": "payments-screen",
        "section_type": "modal",
        "sectionHome": true,
        "sectionHomeOption": "payments"
      }
    },
    {
      "componentName": "ScreenBuilder_frame",
      "nodeId": "289:50",
      "properties": {
        "id": "account-detail",
        "section_type": "slide",
        "sectionHome": false
      }
    }
  ]
}
```

### Mapping Logic

#### Step 1: Normalize Data
```javascript
// Normalize all sectionHomeOption to lowercase
sectionHomeOption: "Summary" → "summary"
sectionHomeOption: "Invest" → "invest"
```

#### Step 2: Categorize Components

**Carousel Routes** (main-carousel + sectionHome)
```javascript
{
  id: 'screen-1',
  sectionHomeOption: 'summary',
  component: ScreenBuilder_frame
} → carouselRoutes.tsx
```

**Bottom Nav - Tabs** (slide-panel + sectionHome)
```javascript
{
  id: 'home-screen',
  sectionHomeOption: 'home',
  section_type: 'slide-panel',
  component: ScreenBuilder_frame
} → bottomNavRoutes.tsx (type: 'tab')
```

**Bottom Nav - Modals** (modal + sectionHome)
```javascript
{
  id: 'payments-screen',
  sectionHomeOption: 'payments',
  section_type: 'modal',
  component: ScreenBuilder_frame
} → bottomNavRoutes.tsx (type: 'modal')
```

**Child Routes** (sectionHome: false)
```javascript
{
  id: 'account-detail',
  section_type: 'slide',
  sectionHome: false,
  component: ScreenBuilder_frame
} → childRoutes.tsx (type: 'slide')
```

#### Step 3: Handle Overrides
If multiple components target the same section:
```javascript
// Both target 'summary'
Component A: { sectionHomeOption: 'summary', ... }
Component B: { sectionHomeOption: 'summary', ... }

// Last one wins (Component B overrides A)
Result: carouselRoutes = [{ id: 'summary', component: B }]
```

## Module Generation

### Folder Structure

All generated modules go into: `/src/modules/feature/generated-{appId}/`

```
src/modules/feature/generated-myapp3/
├── summary-screen/
│   ├── index.tsx              # ScreenBuilder wrapper
│   └── screenData.json        # Component configuration
├── everyday-screen/
│   ├── index.tsx              # Journey wrapper
│   └── config.json            # Journey configuration
├── payments-modal/
│   ├── index.tsx
│   └── screenData.json
└── account-detail/
    ├── index.tsx
    └── screenData.json
```

### Component Type Templates

#### ScreenBuilder Component

```typescript
// Generated: /src/modules/feature/generated-myapp3/summary-screen/index.tsx
import React from 'react';
import { ScreenBuilder, type ScreenConfig } from '@dankupfer/dn-components';
import screenData from './screenData.json';

interface GeneratedSummaryProps {
  screenWidth: number;
}

const GeneratedSummary: React.FC<GeneratedSummaryProps> = ({ screenWidth }) => {
  const config = screenData as ScreenConfig;
  
  return (
    <ScreenBuilder 
      config={config} 
      screenWidth={screenWidth} 
      testID="summary-screen"
    />
  );
};

export default GeneratedSummary;
```

#### Journey Component

```typescript
// Generated: /src/modules/feature/generated-myapp3/everyday-screen/index.tsx
import React from 'react';
import { AssistJourney } from '@dankupfer/dn-components';
import config from './config.json';

interface GeneratedEverydayProps {
  screenWidth: number;
}

const GeneratedEveryday: React.FC<GeneratedEverydayProps> = ({ screenWidth }) => {
  return (
    <AssistJourney
      screenWidth={screenWidth}
      enableTTS={config.enableTTS}
      assistantConfig={{
        serverUrl: config.serverUrl,
        debug: config.debug,
        useMockMode: config.useMockMode
      }}
    />
  );
};

export default GeneratedEveryday;
```

### Configuration Files

#### screenData.json (ScreenBuilder)
```json
{
  "scrollable": true,
  "style": {},
  "components": [
    {
      "type": "SectionHeader",
      "props": {
        "id": "header-1",
        "title": "Summary"
      }
    },
    {
      "type": "AccountCard",
      "props": {
        "id": "account-1",
        "title": "Club Lloyds",
        "balance": 836.50,
        "variant": "condensed"
      }
    }
  ]
}
```

#### config.json (Journey)
```json
{
  "journeyType": "AssistJourney",
  "customerId": "customer-1",
  "enableTTS": true,
  "serverUrl": "ws://localhost:3001/api/assist",
  "debug": false,
  "useMockMode": true
}
```

## API Endpoint

### Request

```http
POST /api/app-builder/build
Content-Type: application/json

{
  "appName": "myApp3",
  "appFrame": { ... },
  "components": [ ... ],
  "exportedAt": "2025-10-26T11:47:33.869Z",
  "version": "1.0.0"
}
```

### Response - Success

```json
{
  "success": true,
  "buildId": "build-1234567890",
  "appPath": "/path/to/generated/myApp3",
  "summary": {
    "appName": "myApp3",
    "totalComponents": 12,
    "carouselRoutes": 5,
    "bottomNavRoutes": 5,
    "childRoutes": 2,
    "generatedFiles": 24
  },
  "timestamp": "2025-10-26T11:47:33.869Z"
}
```

### Response - Error

```json
{
  "success": false,
  "error": "Invalid configuration",
  "details": "Missing required property: sectionHomeOption",
  "timestamp": "2025-10-26T11:47:33.869Z"
}
```

## Implementation Flow

### Phase 1: Parse & Validate ✅
1. Receive `fullAppConfig.json`
2. Validate structure and required fields
3. Normalize data (lowercase sectionHomeOption)
4. Categorize components by routing type

### Phase 2: Generate Modules
1. Create app folder: `/generated-{appId}/`
2. For each component:
   - Create module folder
   - Generate index.tsx (ScreenBuilder or Journey)
   - Create configuration file (screenData.json or config.json)
3. Handle naming collisions (append counter if needed)

### Phase 3: Generate Router Files
1. **carouselRoutes.tsx**: Map main-carousel components
2. **bottomNavRoutes.tsx**: Map slide-panel (tabs) and modal components
3. **childRoutes.tsx**: Map all sectionHome=false components
4. Add imports for all generated modules

### Phase 4: Configure App
1. Copy base template (App.assist.tsx)
2. Update ThemeProvider with appFrame.brand and appFrame.mode
3. Update CustomerProvider with appFrame.apiBase
4. Configure AssistRouter to use generated routes

### Phase 5: Package & Deliver
1. Verify all files generated correctly
2. Run validation checks
3. Create build summary
4. Return app path and metadata

## File Generation Examples

### Example 1: ScreenBuilder in Carousel

**Input:**
```json
{
  "componentName": "ScreenBuilder_frame",
  "properties": {
    "id": "summary-screen",
    "section_type": "main-carousel",
    "sectionHome": true,
    "sectionHomeOption": "Summary"
  }
}
```

**Generated Files:**
```
/src/modules/feature/generated-myapp3/summary-screen/
├── index.tsx
└── screenData.json
```

**Added to carouselRoutes.tsx:**
```typescript
{ id: 'summary', name: 'Summary', component: GeneratedSummaryScreen }
```

### Example 2: Journey in Modal

**Input:**
```json
{
  "componentName": "Journey",
  "properties": {
    "journeyOption": "AssistJourney",
    "prop0": "assist-1",
    "prop1": "modal",
    "prop2": true,
    "prop3": "customer-123",
    "sectionHomeOption": "payments"
  }
}
```

**Generated Files:**
```
/src/modules/feature/generated-myapp3/assist-1/
├── index.tsx
└── config.json
```

**Added to bottomNavRoutes.tsx:**
```typescript
{ id: 'payments', name: 'Payments', type: 'modal', component: GeneratedAssist1 }
```

### Example 3: Child Screen

**Input:**
```json
{
  "componentName": "ScreenBuilder_frame",
  "properties": {
    "id": "account-detail",
    "section_type": "slide",
    "sectionHome": false
  }
}
```

**Generated Files:**
```
/src/modules/feature/generated-myapp3/account-detail/
├── index.tsx
└── screenData.json
```

**Added to childRoutes.tsx:**
```typescript
{ id: 'account-detail', name: 'Account Detail', type: 'slide', component: GeneratedAccountDetail }
```

## Error Handling

### Validation Checks

**Required Fields:**
- `appName` must exist
- `appFrame.brand` must be valid
- `components` must be an array
- Each component must have `id` property

**Business Logic:**
- Cannot have duplicate IDs within same routing category
- `sectionHomeOption` required when `sectionHome: true`
- `section_type` must be valid: main-carousel, slide-panel, modal, slide, full

**File System:**
- Check write permissions
- Verify template files exist
- Handle file conflicts gracefully

### Recovery Strategies

**Duplicate IDs:**
```javascript
// If 'summary' already exists, append counter
'summary' → 'summary-2' → 'summary-3'
```

**Missing Configuration:**
```javascript
// Use defaults for missing Journey config
{
  enableTTS: false,
  debug: false,
  useMockMode: true
}
```

**Invalid section_type:**
```javascript
// Default to 'slide' for child routes
invalid_type → 'slide'
```

## Future Enhancements

### Version 2.0
- [ ] Support for nested navigation (stack navigators)
- [ ] Custom component library imports
- [ ] Animation configuration
- [ ] Deep linking setup
- [ ] Push notification configuration

### Version 3.0
- [ ] Multi-language support
- [ ] A/B testing configuration
- [ ] Analytics integration
- [ ] Error boundary setup
- [ ] Performance monitoring

## Testing Strategy

### Unit Tests
- Component categorization logic
- Router file generation
- Module file creation
- Data normalization

### Integration Tests
- Full build pipeline (JSON → App)
- File system operations
- Error handling flows
- Validation checks

### E2E Tests
- API endpoint receives config
- Generated app runs successfully
- Navigation works correctly
- All components render properly

---

**Last Updated**: January 2025  
**Status**: Design Complete - Ready for Implementation  
**Next Step**: Implement Phase 1 (Parse & Validate)